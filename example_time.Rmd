---
title: "SPQR for multivariate model calibration"
output: html_document
date: "2024-04-04"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup

This has the same setup and workflow as Brian's document from the fall, except that the data is time series, and we will be estimating the QF and CDF using SPQR.

```{r load, echo = F}
rm(list=ls())
library(SPQR)
```

## True quantile functions for the data generation

```{r}
# Marginal quantile function for temperature
q1 <- function(u1,y0){  
    a <- 3+0.5*y0
    b <- 4-1.0*y0
    y <- qgamma(u1,a,b)
    return(y)}

# Conditional quantile function for temperature
q2 <- function(u2,y0,y1){
    m <- 1.0-0.5*y1 + 0.5*y0*log(y1)
    s <- 0.2*y1*(1-y0)+.2
    y <- qnorm(u2,m,s)
    return(y)}
```

## Data generation

We want correlated data where the amount of correlation is different for observation and model. We also want there to be autocorrelation (lag-1 in this example) which is different for the 2 variables, and differnt based on whether the data is from observations or model.

```{r Getting correlation uniform data}
set.seed(919)
n  <- 20000
n0 = n*0.4 # for model
n1 = n*0.6 # for observations

# autocorrelated uniform variates for y1
aa1 = arima.sim(n = n1, list(ar = c(0.6)), sd = 1)
aa2 = arima.sim(n = n0, list(ar = c(0.3)), sd = 1)
u1 = pnorm(c(aa1,aa2))
# autocorrelated uniform variates for y2
aa1 = arima.sim(n = n1, list(ar = c(0.75)), sd = 1)
aa2 = arima.sim(n = n0, list(ar = c(0.5)), sd = 1)
u2 = pnorm(c(aa1,aa2))
```

Now, we pass the autocorrelated uniform variates to the true quantile functions, which will spit out correlated y1 and y2.

```{r Generating y1, y2, y0}
y0 <- c(rep(1,n*.6),rep(0,n*.4))
y1 <- q1(u1,y0)
y2 <- q2(u2,y0,y1)
```

## Visualizing the bias

Red is observational, black is model

```{r}
plot(y1,y2,col=y0+1)
# Correlation in the model output
 cor(y1[y0==0],y2[y0==0])
 # Correlation in the observations
 cor(y1[y0==1],y2[y0==1])
```

## Bias correction of precipitation

```{r}
y11 = y1[y0==1]
x11 = y11[c(n1,1:(n1-1))]
# Autocorrelation for observational precip
cor(cbind(y11,x11))
y10 = y1[y0==0]
x10 = y10[c(n0,1:(n0-1))]
# Autocorrelation for model precip
cor(cbind(y10,x10))
y1 = c(y11,y10)
x1 = c(x11,x10)
X1 = cbind(x1,y0)
```

```{r, results="hide"}
# Fit and SPQR model
control <- list(iter = 300, batch.size = 1000, lr = 0.01)
fit.y1.mle.ts <- SPQR(X = X1, Y = y1, method = "MLE", control = control, normalize = T, verbose = T,use.GPU=T,
                      n.hidden = c(30,20), activation = 'relu',n.knots = 15)

# Solve for the latent factors
cdf.y1.mle.ts = rep(NA,n)
for(i in 1:n){
    cdf.y1.mle.ts[i] <- predict(fit.y1.mle.ts,   X = X1[i,], Y=y1[i], type = "CDF")    
    # print(i)
}
```

```{r, results="hide"}
qout11 <- cdf.y1.mle.ts
adjust = which(qout11>0.99999)
qout11[adjust] = 0.99999
# Project from latent to observed space
qf.y1.mle.ts = rep(NA,n)
x_pred = c(X1[1,1],1) # set everything to observations
qf.y1.mle.ts[1] <- predict(fit.y1.mle.ts,   X = x_pred, type = "QF",tau=qout11[1])    
for(i in 2:n){
    # print(i)
    if(i==12001)
        x_pred = c(X1[i,1],1)
    if(i!=12001)
        x_pred = c(qf.y1.mle.ts[i-1],1)
    qf.y1.mle.ts[i] <- predict(fit.y1.mle.ts,   X = x_pred, type = "QF",tau=qout11[i])
}
```

## Bias corrected precipitation

```{r}
plot(y1,qf.y1.mle.ts,col=y0+1, main = 'MLE-TS')
abline(0,1)
```
```{r}
summary(qf.y1.mle.ts[y0==0]) # summary of bias corrected precip
summary(qf.y1.mle.ts[y0==1]) # summary of model precip
cor(qf.y1.mle.ts[y0==0][-1],qf.y1.mle.ts[y0==0][-8000]) # autocorrelation in bias corrected precip
cor(qf.y1.mle.ts[y0==1][-1],qf.y1.mle.ts[y0==1][-12000]) # autocorrelation in observational precip

summary(y1[y0==1]) # summary of observational precip
summary(y1[y0==0]) # summary of model precip
```
## Plot the densities
```{r}
d0 <-density(y1[y0==0]) 
d1 <-density(y1[y0==1]) 
d2 <- density(qf.y1.mle.ts[y0==0])
plot(d0,col=1,ylim=range(c(d0$y,d1$y)),ylab="Y1",main="Y1")
lines(d1,col=2)
lines(d2,col=3,lty=2)

legend("topright",c("Model","Observations",'MLE-TS'),
       col=1:6,lwd=2,bty="n",lty=c(1,1,2,3))
```

## Plot of model vs. calibrated precip
```{r}
start = 51
end = 100
maxy = 1.10*max(y1[(12001+start):(12000+end)],qf.y1.mle.ts[(12001+start):(12000+end)])
miny = 0.90*min(y1[(12001+start):(12000+end)],qf.y1.mle.ts[(12001+start):(12000+end)])

plot(start:end,y1[(12000+start):(12000+end)],col=1,type='b',pch=20,ylim=c(miny,maxy),
     ylab = 'Precip')
lines(start:end,qf.y1.mle.ts[(12000+start):(12000+end)],col=2,type = 'b',pch=20)
legend("topleft",c("Model",'calibrated'),
       col=1:2,lwd=2,bty="n")
```

## Bias correction for the conditional distribution of temperature
```{r}
# Prep the data
y21 = y2[y0==1]
x21 = y21[c(n1,1:(n1-1))]
cor(cbind(y21,x21)) # autocorrelation for observed temp
y20 = y2[y0==0]
x20 = y20[c(n0,1:(n0-1))] # autocorrelation for model temp
cor(cbind(y20,x20))
y2 = c(y21,y20)
x2 = c(x21,x20)
X2 = cbind(x2,y1,X1)
```
```{r, results="hide"}
# Fit the SPQR model
fit.y2.mle.ts <- SPQR(X = X2, Y = y2, method = "MLE", control = control, normalize = T, verbose = T,use.GPU=T,
                      n.hidden = c(20,10), activation = 'relu',n.knots = 20)
# Solve for the latent factors
cdf.y2.mle.ts = rep(NA,n)
for(i in 1:n){
    cdf.y2.mle.ts[i] <- predict(fit.y2.mle.ts,   X = X2[i,], Y=y2[i], type = "CDF")    
    # print(i)
}
```
```{r}
qout21 <- cdf.y2.mle.ts
adjust = which(qout21>0.99999)
qout21[adjust] = 0.99999

# Project from latent of observed space
qf.y2.mle.ts = rep(NA,n)
x_pred = c(X2[1,1],qf.y1.mle.ts[1],X2[1,3],1) # Set everything to observations
qf.y2.mle.ts[1] <- predict(fit.y2.mle.ts,   X = x_pred, type = "QF",tau=qout21[1])    
for(i in 2:n){
    # print(i)
    if(i!=12001)
        x_pred = c(qf.y2.mle.ts[i-1],qf.y1.mle.ts[i],qf.y1.mle.ts[i-1],1)
    if(i==12001)
        x_pred = c(X2[i,1],qf.y1.mle.ts[i],X2[i,3],1)
    qf.y2.mle.ts[i] <- predict(fit.y2.mle.ts,   X = x_pred, type = "QF",tau=qout21[i])
}
```

## Bias corrected temperature
```{r}
plot(y2,qf.y2.mle.ts,col=y0+1, main = 'MLE-TS')
abline(0,1)
```

## Summaries
```{r}
summary(qf.y2.mle.ts[y0==0]) # Summary of bias-corrected temp
summary(qf.y2.mle.ts[y0==1]) # Summary of observed temp
cor(qf.y2.mle.ts[y0==0][-1],qf.y2.mle.ts[y0==0][-8000]) # autocorrelation of bias corrected temp
cor(qf.y2.mle.ts[y0==1][-1],qf.y2.mle.ts[y0==1][-12000]) # autocorrelation of observed temp

summary(y2[y0==1]) # summary of original observational temp
summary(y2[y0==0]) # sumamry of original model temp
```

## Plot bias corrected densities
```{r}
d0 <-density(y2[y0==0]) 
d1 <-density(y2[y0==1]) 
d2 <- density(qf.y2.mle.ts[y0==0])
plot(d0,col=1,ylim=range(c(d0$y,d1$y)),ylab="Y2",main="Y2")
lines(d1,col=2)
lines(d2,col=2,lty=2)

legend("topright",c("Model","Observations",'MLE-TS'),
       col=1:6,lwd=2,bty="n",lty=c(1,1,2,3))

plot(qf.y1.mle.ts,qf.y2.mle.ts,col = y0+1)

```

## Plot of model vs. calibrated temp
```{r}
start = 51
end = 100
maxy = 1.10*max(y2[(12001+start):(12000+end)],qf.y2.mle.ts[(12001+start):(12000+end)])
miny = 0.90*min(y2[(12001+start):(12000+end)],qf.y2.mle.ts[(12001+start):(12000+end)])

plot(start:end,y2[(12000+start):(12000+end)],col=1,type='b',pch=20,ylim=c(miny,maxy),
     ylab = 'temp')
lines(start:end,qf.y2.mle.ts[(12000+start):(12000+end)],col=2,type = 'b',pch=20)
legend("bottomleft",c("Model",'calibrated'),
       col=1:2,lwd=2,bty="n")
```
